{"version":3,"sources":["../../../../src/viewtransaction/viewTransaction.es6"],"names":["open_dialogs","require","market_data_disruption_win","show_market_data_disruption_win","proposal","moveToTop","msg","i18n","root","windows","createBlankWindow","title","height","resizable","collapsable","minimizable","maximizable","destroy","dialog","remove","window","dd","init_chart","state","options","data","type","decimal_digits","history","times","prices","i","length","push","Math","max","substring","indexOf","candles","map","c","epoch","open","high","low","close","el","find","chart_options","credits","href","text","chart","renderTo","backgroundColor","width","marginLeft","marginRight","tooltip","xDateFormat","valueDecimals","undefined","xAxis","categories","startOnTick","endOnTick","min","_","first","last","labels","overflow","format","yAxis","align","x","y","series","name","exporting","enabled","enableImages","legend","navigator","plotOptions","line","marker","radius","candlestick","lineColor","color","upColor","upLineColor","shadow","rangeSelector","Highcharts","Chart","addPlotLineX","addPlotLine","value","id","label","text_left","zIndex","addPlotLineY","get_tick_value","symbol","liveapi","send","ticks_history","granularity","style","start","end","count","catch","err","console","error","init","contract_id","transaction_id","Promise","resolve","reject","proposal_open_contract","then","underlying","shortcode","init_dialog","$","growl","message","update_indicative","forget","echo_req","subscribe","contract","bid_price","is_sold","exit_tick","exit_level","table","user_sold","sell_spot","sell_time","date_expiry","validation_error","validation","is_expired","is_valid_to_sell","is_forward_starting","date_start","current_spot_time","fwd_starting","current_spot","sell","bid_prices","shift","isNil","toString","split","unit","cent","manual_reflow","entry_tick","entry_tick_time","exit_tick_time","sell_price","final_price","barrier","high_barrier","low_barrier","update_barrier","html","init_state","on_proposal_open_contract","transWin","display_name","minWidth","minHeight","view","unbind","events","off","onclose","on","resize","rv","bind","sell_at_market","sell_at_market_enabled","price","buy_price","state_confirm","longcode","sold_for","return_percent","toFixed","balance","balance_after","currency","$html","after","view_confirm","route","update","is_settleable","is_ended","contract_type","entry_spot","barrier_count","multiplier","tick_count","prediction","sell_spot_time","purchase_time","is_sold_at_market","isLookback","Lookback","lb_formula","formula","formatPrice","loading","barrierLabels","barrier_label","low_barrier_label","h","container","transactionChart","setSize","hasUserSize","showLoading","hideLoading","get_chart_data","update_live_chart","key","chartingRequestMap","keyFor","req","register","on_tick","on_candles","perv_tick","tick","addPoint","quote","clean_up","data_key","ohlc","open_time","clean_up_done","unregister","isUpdate","addPlotlines","removePlotlines","removePlotLine","duration","moment","utc","unix","margin","request","stop_loss_level","stop_profit_level"],"mappings":"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","file":"viewTransaction.js","sourcesContent":["﻿/**\n * Created by amin on January 14, 2016.\n */\n\nimport $ from 'jquery';\nimport windows from 'windows/windows';\nimport liveapi from 'websockets/binary_websockets';\nimport chartingRequestMap from 'charts/chartingRequestMap';\nimport rv from 'common/rivetsExtra';\nimport moment from 'moment';\nimport _ from 'lodash';\nimport 'jquery-growl';\nimport 'common/util';\nimport Lookback from 'trade/lookback';\n\nconst open_dialogs = {};\n\nrequire(['css!viewtransaction/viewTransaction.css']);\nrequire(['text!viewtransaction/viewTransaction.html']);\n\nlet market_data_disruption_win = null;\nconst show_market_data_disruption_win = (proposal) => {\n   if(market_data_disruption_win){\n      market_data_disruption_win.moveToTop();\n      return;\n   }\n   const msg = 'There was a market data disruption during the contract period. For real-money accounts we will attempt to correct this and settle the contract properly, otherwise the contract will be cancelled and refunded. Virtual-money contracts will be cancelled and refunded.'.i18n();\n   // const msg = proposal.validation_error;\n   const root = $('<div class=\"data-disruption-dialog\">' + msg + '</div>');\n\n   market_data_disruption_win = windows.createBlankWindow(root, {\n      title: ' There was an error '.i18n(),\n      height: 200,\n      resizable:false,\n      collapsable:false,\n      minimizable: false,\n      maximizable: false,\n      destroy: () => {\n         market_data_disruption_win && market_data_disruption_win.dialog('destroy').remove();\n         market_data_disruption_win = null;\n      },\n      'data-authorized': 'true'\n   });\n\n   market_data_disruption_win.dialog('open');\n   window.dd = market_data_disruption_win;\n}\n\nconst init_chart = (root, state, options) => {\n   let data = [];\n   let type = '';\n   let decimal_digits = 0;\n   if(options.history){\n      type = 'line';\n      const history = options.history;\n      const times = history.times;\n      const prices = history.prices;\n      for(let i = 0; i < times.length; ++i) {\n         data.push([times[i]*1000, prices[i]*1]);\n         decimal_digits = Math.max(decimal_digits, prices[i].substring(prices[i].indexOf('.') + 1).length);\n      }\n   }\n   if(options.candles) {\n      type = 'candlestick';\n      data = options.candles.map(\n         (c) => [c.epoch*1000, c.open*1, c.high*1, c.low*1, c.close*1]\n      )\n   }\n   const title = options.title;\n   const el = root.find('.transaction-chart')[0];\n\n   const chart_options = {\n      credits: { href: '#', text: '' },\n      chart: {\n         type: 'line',\n         renderTo: el,\n         backgroundColor: null, /* make background transparent */\n         width: 0,\n         height: 0,\n         marginLeft:20,\n         marginRight:20\n      },\n      title:{\n         text: '' // Removing the title because it is redundant.\n      },\n      tooltip:{\n         xDateFormat:'%A, %b %e, %H:%M:%S GMT',\n         valueDecimals: decimal_digits || undefined,\n      },\n      xAxis: {\n         type: 'datetime',\n         categories:null,\n         startOnTick: false,\n         endOnTick: false,\n         min: data.length ? _.first(data)[0] : null,\n         max: data.length ? _.last(data)[0] : null,\n         labels: { overflow:\"justify\", format:\"{value:%H:%M:%S}\" },\n      },\n      yAxis: {\n         labels: { align: 'left', x: 0, y: -2 },\n         title: '',\n         // gridLineWidth: 0,\n      },\n      series: [{\n         name: title,\n         data: data,\n         type: type\n      }],\n      exporting: {enabled: false, enableImages: false},\n      legend: {enabled: false},\n      navigator: { enabled: true },\n      plotOptions: {\n         line: {\n            marker: { radius: 2 }\n         },\n         candlestick: {\n            lineColor: 'black',\n            color: 'red',\n            upColor: 'green',\n            upLineColor: 'black',\n            shadow: true\n         },\n      },\n      rangeSelector: { enabled: false },\n   };\n   const chart = new Highcharts.Chart(chart_options);\n\n   chart.addPlotLineX = (options) => {\n      chart.xAxis[0].addPlotLine({\n         value: options.value,\n         id: options.id || options.value,\n         label: {text: options.label || 'label', x: options.text_left ? -15 : 5},\n         color: options.color || '#e98024',\n         zIndex: 4,\n         width: options.width || 2,\n      });\n   };\n\n   chart.addPlotLineY = (options) => {\n      chart.yAxis[0].addPlotLine({\n         id: options.id || options.label,\n         value: options.value,\n         label: {text: options.label, align: 'center'},\n         color: options.color || 'green',\n         zIndex: 4,\n         width: 2,\n      });\n   };\n   return el.chart = chart;\n};\n\n/* get the tick value for a given epoch */\nconst get_tick_value = (symbol, epoch) => {\n   return liveapi.send({ticks_history: symbol, granularity: 0, style:'ticks', start: epoch, end:epoch+2, count: 1})\n      .catch((err) => console.error(err));\n}\n\nexport const init = (contract_id, transaction_id) => {\n   return new Promise((resolve, reject) => {\n      if(open_dialogs[transaction_id]) {\n         open_dialogs[transaction_id].moveToTop();\n         resolve();\n         return;\n      }\n      liveapi.send({proposal_open_contract: 1, contract_id: contract_id})\n            .then((data) => {\n            const proposal = data.proposal_open_contract;\n            /* check for market data disruption error */\n            if(proposal.underlying === undefined && proposal.shortcode === undefined) {\n               show_market_data_disruption_win(proposal);\n               return;\n            }\n            proposal.transaction_id = transaction_id;\n            proposal.symbol = proposal.underlying;\n            init_dialog(proposal);\n            resolve();\n         })\n         .catch((err) => {\n            console.error(err);\n            $.growl.error({ message: err.message });\n            reject();\n         });\n   });\n}\n\nconst update_indicative = (data, state) => {\n   if(data.error) {\n      $.growl.error({message: data.error.message});\n      liveapi.proposal_open_contract.forget(data.echo_req.contract_id);\n      liveapi.proposal_open_contract.subscribe(data.echo_req.contract_id);\n      return;\n   }\n   const contract = data.proposal_open_contract;\n   const id = contract.contract_id || data.echo_req.contract_id,\n      bid_price = contract.bid_price;\n   if(contract.is_sold && !contract.exit_tick && !contract.exit_level && !state.table.user_sold && !contract.sell_spot) {\n\n      liveapi.send({contract_id: id, proposal_open_contract: 1});\n      return;\n   }\n\n   state.table.user_sold = contract.sell_time && contract.sell_time < contract.date_expiry;\n\n   if(id != state.contract_id) { return; }\n   if(contract.validation_error)\n      state.validation = contract.validation_error;\n   else if(contract.is_expired)\n      state.validation = 'This contract has expired'.i18n();\n   else if(contract.is_valid_to_sell)\n      state.validation = 'Note: Contract will be sold at the prevailing market price when the request is received by our servers. This price may differ from the indicated price.'.i18n();\n   if(contract.is_forward_starting && contract.date_start*1 > contract.current_spot_time*1)\n      state.fwd_starting = '* Contract is not yet started.'.i18n();\n   else\n      state.fwd_starting = '';\n   /*Do not update the current_spot and current_spot_time if the contract has expired*/\n   if(state.table.date_expiry*1 >= contract.current_spot_time*1) {\n      state.table.current_spot = contract.current_spot;\n      state.table.current_spot_time = contract.current_spot_time;\n      state.table.bid_price = contract.bid_price;\n      if(state.sell.bid_prices.length > 40) {\n         state.sell.bid_prices.shift();\n      }\n      state.sell.bid_prices.push(contract.bid_price)\n      if(!_.isNil(contract.bid_price)) {\n         state.sell.bid_price.value = contract.bid_price;\n         [state.sell.bid_price.unit, state.sell.bid_price.cent] = contract.bid_price.toString().split(/[\\.,]+/);\n      }\n      state.sell.is_valid_to_sell = contract.is_valid_to_sell;\n      state.chart.manual_reflow();\n   } else {\n      /*Just change the current_spot_time to date_expiry*/\n      state.table.current_spot_time = state.table.date_expiry;\n   }\n\n   // Some times backend doesn't send the entry-spot in the beginning. Setting it here to avoid any errors.\n   state.table.entry_tick = contract.entry_tick ? contract.entry_tick : state.table.entry_tick;\n   state.table.entry_tick_time = contract.entry_tick_time ? contract.entry_tick_time : state.table.entry_tick_time;\n\n   if(contract.is_sold){\n      state.table.is_sold = contract.is_sold;\n      state.table.exit_tick = contract.exit_tick;\n      state.table.exit_tick_time = contract.exit_tick_time;\n      state.table.date_expiry = contract.date_expiry;\n      state.table.current_spot_time = contract.exit_tick_time;\n      state.table.sell_price = contract.sell_price;\n      state.table.final_price = contract.sell_price;\n      !state.table.user_sold && state.table.exit_tick_time && state.chart.chart.addPlotLineX({ value: state.table.exit_tick_time*1000, label: 'Exit Spot'.i18n(), text_left: true});\n      !state.table.user_sold && state.table.date_expiry && state.chart.chart.addPlotLineX({ value: state.table.date_expiry*1000, label: 'End Time'.i18n()});\n      state.table.user_sold && state.table.sell_price && state.chart.chart.addPlotLineX({ value: contract.sell_time*1000, label: 'Sell Time'.i18n()});\n   }\n\n   if(+state.chart.barrier !== +contract.barrier ||\n      +state.chart.high_barrier !== +contract.high_barrier ||\n      +state.chart.low_barrier !== +contract.low_barrier ) {\n        update_barrier(true, state, contract);\n   }\n}\n\nconst init_dialog = (proposal) => {\n   require(['text!viewtransaction/viewTransaction.html'],(html) => {\n      const root = $(html).i18n();\n      const state = init_state(proposal, root);\n      const on_proposal_open_contract = (data) => update_indicative(data, state);\n\n      const transWin = windows.createBlankWindow(root, {\n         title: proposal.display_name + ' (' + proposal.transaction_id + ')',\n         width: 700,\n         minWidth: 490,\n         minHeight:480,\n         height:480,\n         destroy: () => { },\n         close: function() {\n            view && view.unbind();\n            liveapi.proposal_open_contract.forget(proposal.contract_id);\n            liveapi.events.off('proposal_open_contract', on_proposal_open_contract);\n            for(let i = 0; i < state.onclose.length; ++i)\n               state.onclose[i]();\n            $(this).dialog('destroy').remove();\n            open_dialogs[proposal.transaction_id] = undefined;\n         },\n         open: () => {\n            liveapi.proposal_open_contract.subscribe(proposal.contract_id);\n            liveapi.events.on('proposal_open_contract', on_proposal_open_contract);\n         },\n         resize: () => {\n            state.chart.manual_reflow();\n            // state.chart.chart && state.chart.chart.reflow();\n         },\n         'data-authorized': 'true'\n      });\n\n      transWin.dialog('open');\n      const view = rv.bind(root[0],state)\n      open_dialogs[proposal.transaction_id] = transWin;\n   });\n}\n\nconst sell_at_market = (state, root) => {\n   state.sell.sell_at_market_enabled = false; /* disable button */\n   require(['text!viewtransaction/viewTransactionConfirm.html', 'css!viewtransaction/viewTransactionConfirm.css']);\n   liveapi.send({sell: state.contract_id, price: 0 /* to sell at market */})\n      .then((data) => {\n         state.table.user_sold = true; //User successfully sold the contract\n         const sell = data.sell;\n         require(['text!viewtransaction/viewTransactionConfirm.html', 'css!viewtransaction/viewTransactionConfirm.css'],\n            (html) => {\n               const buy_price = state.table.buy_price;\n               const state_confirm = {\n                  longcode: state.longcode,\n                  buy_price: buy_price,\n                  sell_price: sell.sold_for,\n                  return_percent: (100*(sell.sold_for - buy_price)/buy_price).toFixed(2)+'%',\n                  transaction_id: sell.transaction_id,\n                  balance: sell.balance_after,\n                  currency: state.table.currency,\n               };\n               const $html = $(html).i18n();\n               root.after($html);\n               const view_confirm = rv.bind($html[0], state_confirm);\n               state.onclose.push(() => {\n                  view_confirm && view_confirm.unbind();\n               });\n            });\n      })\n      .catch((err) => {\n         $.growl.error({ message: err.message });\n         console.error(err);\n      });\n}\n\nconst init_state = (proposal, root) =>{\n   const state = {\n      route: {\n         value: 'table',\n         update:(value) => { state.route.value = value; }\n      },\n      contract_id: proposal.contract_id,\n      longcode: proposal.longcode,\n      validation: proposal.validation_error\n      || (!proposal.is_valid_to_sell && 'Resale of this contract is not offered'.i18n())\n      || ((proposal.is_settleable || proposal.is_sold) && 'This contract has expired'.i18n()) || '-',\n      table: {\n         is_ended: proposal.is_settleable || proposal.is_sold,\n         currency: (proposal.currency ||  'USD') + ' ',\n         current_spot_time: proposal.current_spot_time,\n         current_spot: proposal.current_spot,\n         contract_type: proposal.contract_type,\n         date_start: proposal.date_start,\n         date_expiry: proposal.date_expiry,\n         user_sold: proposal.sell_time && proposal.sell_time < proposal.date_expiry,\n\n         entry_tick: proposal.entry_tick || proposal.entry_spot,\n         entry_tick_time: proposal.entry_tick_time ? proposal.entry_tick_time * 1 : proposal.date_start * 1,\n         exit_tick: proposal.exit_tick,\n         exit_tick_time: proposal.exit_tick_time,\n\n         barrier_count: proposal.barrier_count,\n         low_barrier: proposal.low_barrier,\n         high_barrier: proposal.high_barrier,\n\n         multiplier: proposal.multiplier,\n         buy_price: proposal.buy_price,\n         bid_price: undefined,\n         final_price: proposal.is_sold ? proposal.sell_price : undefined,\n\n         tick_count: proposal.tick_count,\n         prediction: proposal.prediction,\n\n         sell_time: proposal.sell_spot_time * 1 || undefined,\n         sell_spot: proposal.sell_spot,\n         sell_price: proposal.is_sold ? proposal.sell_price : undefined,\n         purchase_time: proposal.purchase_time,\n         is_sold_at_market: false,\n         isLookback: Lookback.isLookback(proposal.contract_type),\n         lb_formula: Lookback.formula(proposal.contract_type, proposal.multiplier && formatPrice(proposal.multiplier, proposal.currency ||  'USD')),\n      },\n      chart: {\n         chart: null, /* highchart object */\n         symbol: proposal.symbol,\n         display_name: proposal.display_name,\n         barrier: proposal.barrier,\n         high_barrier: proposal.high_barrier,\n         low_barrier: proposal.low_barrier,\n         loading: 'Loading ' + proposal.display_name + ' ...',\n         type: 'ticks', // could be 'tick' or 'ohlc'\n      },\n      sell: {\n         bid_prices: [],\n         bid_price: {\n            unit: undefined,\n            cent: undefined,\n            value: undefined,\n         },\n         sell_at_market_enabled: true,\n         is_valid_to_sell: false,\n      },\n      onclose: [], /* cleanup callback array when dialog is closed */\n   };\n\n   if(Lookback.isLookback(proposal.contract_type)) {\n     [state.table.barrier_label, state.table.low_barrier_label] = Lookback.barrierLabels(proposal.contract_type);\n   }\n\n   state.sell.sell = () => sell_at_market(state, root);\n\n   state.chart.manual_reflow = () => {\n      /* TODO: find a better solution for resizing the chart  :/ */\n      const h = -1 * (root.find('.longcode').height() + root.find('.tabs').height() + root.find('.footer').height()) - 16;\n      if(!state.chart.chart) return;\n      const container = root;// root.find('.chart-container');\n      const transactionChart = container.find(\".transaction-chart\");\n      const width = container.width() - 10,\n         height = container.height();\n      state.chart.chart.setSize(width, height + h , false);\n      state.chart.chart.hasUserSize = null;\n      if (state.chart.chart.series[0] && state.chart.chart.series[0].data.length === 0)\n         state.chart.chart.showLoading();\n      else\n         state.chart.chart.hideLoading();\n   };\n\n   get_chart_data(state, root);\n   return state;\n}\n\nconst update_live_chart = (state, granularity) => {\n   const key = chartingRequestMap.keyFor(state.chart.symbol, granularity);\n   if(!chartingRequestMap[key]){\n      const req = {\n         symbol: state.chart.symbol,\n         subscribe: 1,\n         granularity: granularity,\n         style: granularity === 0 ? 'ticks' : 'candles',\n      };\n      chartingRequestMap.register(req)\n         .catch((err) => {\n            $.growl.error({ message: err.message });\n            console.error(err);\n         });\n   }\n   /* don't register if already someone else has registered for this symbol */\n   else { chartingRequestMap.subscribe(key); }\n\n   let on_tick = undefined;\n   let on_candles = undefined;\n\n   if(granularity === 0) {\n      let perv_tick = null;\n      on_tick = liveapi.events.on('tick', (data) => {\n         if (!data.tick || data.tick.symbol !== state.chart.symbol)\n            return;\n         const chart = state.chart.chart;\n         const tick = data.tick;\n         chart && chart.series[0].addPoint([tick.epoch*1000, tick.quote*1]);\n         /* stop updating when contract is expired */\n         if(tick.epoch*1 > state.table.date_expiry*1 || state.table.is_sold) {\n            if(perv_tick && state.table.contract_type !== 'SPREAD') {\n               state.table.exit_tick = perv_tick.quote;\n               state.table.exit_tick_time = perv_tick.epoch*1;\n               state.validation = 'This contract has expired'.i18n();\n               state.table.is_ended = true;\n            }\n            clean_up();\n         }\n         perv_tick = tick;\n      });\n   }\n   else {\n      on_candles = liveapi.events.on('ohlc', (data) => {\n         const data_key = chartingRequestMap.keyFor(data.ohlc.symbol, data.ohlc.granularity);\n         if(key != data_key)\n            return;\n         const chart = state.chart.chart;\n         if(!chart)\n            return;\n\n         const series = chart.series[0];\n         const last = series.data[series.data.length - 1];\n\n         const c = data.ohlc;\n         const ohlc = [c.open_time*1000, c.open*1, c.high*1, c.low*1, c.close*1];\n\n         if(last.x != ohlc[0]) {\n            series.addPoint(ohlc, true, true);\n         }\n         else {\n            last.update(ohlc,true);\n         }\n         /* stop updating when contract is expired */\n         if(c.epoch*1 > state.table.date_expiry*1) {\n            clean_up();\n         }\n      });\n   }\n\n   let clean_up_done = false;\n   const clean_up = () => {\n      if(clean_up_done) return;\n      clean_up_done = true;\n      chartingRequestMap.unregister(key);\n      on_tick && liveapi.events.off('tick', on_tick);\n      on_candles && liveapi.events.off('candles', on_candles);\n   };\n   state.onclose.push(clean_up); /* clean up */\n}\n\nconst update_barrier = (isUpdate, state, contract = {}) => {\n  const {chart} = state.chart;\n  if (!chart) return;\n  const addPlotlines = () => {\n    state.chart.barrier && chart.addPlotLineY({\n      id: 'barrier',\n      value: state.chart.barrier*1,\n      label: `${state.table.barrier_label || 'Barrier'.i18n()} ( ${state.chart.barrier} )`\n    });\n    state.chart.high_barrier && chart.addPlotLineY({\n      id: 'high_barrier',\n      value: state.chart.high_barrier*1,\n      label: `${state.table.barrier_label || 'High Barrier'.i18n()} ( ${state.chart.high_barrier} )`\n    });\n    state.chart.low_barrier && chart.addPlotLineY({\n      id: 'low_barrier',\n      value: state.chart.low_barrier*1,\n      label: `${state.table.low_barrier_label || 'Low Barrier'.i18n()} ( ${state.chart.low_barrier} )`,\n      color: 'red'\n    });\n  };\n\n  const removePlotlines = () => {\n    state.chart.barrier && chart.yAxis[0].removePlotLine('barrier');\n    state.chart.high_barrier && chart.yAxis[0].removePlotLine('high_barrier');\n    state.chart.low_barrier && chart.yAxis[0].removePlotLine('low_barrier');\n  }\n  if (isUpdate) {\n    removePlotlines();\n    state.chart.barrier = state.table.barrier = contract.barrier;\n    state.chart.high_barrier = state.table.high_barrier = contract.high_barrier;\n    state.chart.low_barrier = state.table.low_barrier = contract.low_barrier;\n    addPlotlines();\n  } else {\n    addPlotlines();\n  }\n}\n\nconst get_chart_data = (state, root) => {\n   const table = state.table;\n   const duration = Math.min(state.table.date_expiry*1, moment.utc().unix()) - (state.table.purchase_time || state.table.date_start);\n   let granularity = 0;\n   let margin = 0; // time margin\n   if(duration <= 60*60) { granularity = 0; } // 1 hour\n   else if(duration <= 2*60*60) { granularity = 60; } // 2 hours\n   else if(duration <= 6*60*60) { granularity = 120; } // 6 hours\n   else if(duration <= 24*60*60) { granularity = 300; } // 1 day\n   else { granularity = 3600 } // more than 1 day\n   margin = granularity === 0 ? Math.max(3, 30*duration/(60*60) | 0) : 3*granularity;\n   const request = {\n      ticks_history: state.chart.symbol,\n      start: (state.table.purchase_time || state.table.date_start)*1 - margin, /* load around 2 more thicks before start */\n      end: state.table.sell_time ? state.table.sell_time*1 + margin : state.table.exit_tick_time ? state.table.exit_tick_time*1 + margin : 'latest',\n      style: 'ticks',\n      count: 4999, /* maximum number of ticks possible */\n   };\n   if(granularity !== 0) {\n      request.granularity = granularity;\n      request.style = 'candles';\n      state.chart.type = 'candles';\n   }\n\n   if(!state.table.is_ended) {\n      update_live_chart(state, granularity);\n   }\n\n   return liveapi.send(request).then((data) => {\n\n      state.chart.loading = '';\n\n      const options = { title: state.chart.display_name };\n      if(data.history) options.history = data.history;\n      if(data.candles) options.candles = data.candles;\n      const chart = init_chart(root, state, options);\n\n      state.table.entry_tick_time && chart.addPlotLineX({ value: state.table.entry_tick_time*1000, label: 'Entry Spot'.i18n()});\n\n      (!state.table.user_sold || state.table.contract_type === \"SPREAD\") && chart.addPlotLineX({ value: state.table.exit_tick_time*1000, label: 'Exit Spot'.i18n(), text_left: true});\n\n      state.table.entry_tick_time && chart.addPlotLineX({ value: state.table.entry_tick_time*1000, label: 'Entry Spot'.i18n()});\n      !state.table.user_sold && state.table.exit_tick_time && chart.addPlotLineX({ value: state.table.exit_tick_time*1000, label: 'Exit Spot'.i18n(), text_left: true});\n\n      !state.table.user_sold && state.table.date_expiry && chart.addPlotLineX({ value: state.table.date_expiry*1000, label: 'End Time'.i18n()});\n      state.table.date_start && chart.addPlotLineX({ value: state.table.date_start*1000, label: 'Start Time'.i18n() ,text_left: true });\n\n      update_barrier(false, state);\n\n      state.table.stop_loss_level && chart.addPlotLineY({value: state.table.stop_loss_level*1, label: 'Stop Loss ('.i18n() + state.table.stop_loss_level + ')', color: 'red'});\n      state.table.stop_profit_level && chart.addPlotLineY({value: state.table.stop_profit_level*1, label: 'Stop Profit ('.i18n() + state.table.stop_profit_level + ')'});\n\n      state.table.user_sold && chart.addPlotLineX({ value: state.table.sell_time*1000, label: 'Sell Spot'.i18n(), text_left: true});\n\n      state.chart.chart = chart;\n      state.chart.manual_reflow();\n   })\n      .catch((err) => {\n         state.chart.loading = err.message;\n         console.error(err);\n      });\n}\n\nexport default  { init };\n"]}